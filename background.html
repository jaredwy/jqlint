<!doctype html>
<head>
    <script src="parse-js.js"></script>
    <script type="text/javascript">

    function isJQueryCall(node) {
        return node.length > 2 && node[0] == 'call' && node[1][0] == 'name' && ['$', 'jQuery'].indexOf(node[1][1]) != -1 && node[2][0][0] == 'string';
    }
    function findJQuerySelectors(tree) {
    if(tree && tree.constructor == Array) {
        if(isJQueryCall(tree)) {
            return tree[2][0][1];
        }
        return [].concat.apply([], tree.map(findJQuerySelectors));
    }
    return [];
}




/**
 * @param {Array} scripts an array of script infos to validate
 * @returns {Array} of arrays containing errors for each script
 */
function validate(scripts) {
  var validation = [];
  scripts.forEach(function(script) {
    validation.push(parseScript(script));
  });

  console.log('all scripts validated', validation);
  return validation;
}

function parseScript(scriptInfo) {
    var errors = [];
    
    var ast = parsejs.parse(scriptInfo.contents)[1];
    var selectors = findJQuerySelectors(ast);

    console.log(selectors);
    console.log(scriptInfo.contents);
    return errors;
}

chrome.extension.onRequest.addListener(function(request, sender, callback) {
  chrome.tabs.getSelected(null, function(tab) {
    chrome.tabs.executeScript(tab.id, {file: 'content.js'}, function() {
      chrome.tabs.sendRequest(tab.id, {}, function(response) {
        if (response.error) {
          // Something bad. Pass error up the chain.
          callback({error: response.error});
          return;
        }
        callback({files: validate(response.scripts)});
      });
    });
  });
});

</script>
</head>
</html>
